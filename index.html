<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒ€ ì •ì‚° ì–´í”Œ (Final V37)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* [Update: 2026-02-17-v37] í˜„ëŒ€ì  ì»¬ëŸ¬ & ì˜ìˆ˜ì¦ ìŠ¤íƒ€ì¼ ì ìš© */
        :root { 
            --primary: #6366f1; /* ì†Œí”„íŠ¸ ì¸ë””ê³  */
            --primary-dark: #4f46e5;
            --bg: #f1f5f9; /* ì—°í•œ ê·¸ë ˆì´ ë¸”ë£¨ ë°°ê²½ */
            --card-bg: rgba(255, 255, 255, 0.7); /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ìš© */
            --danger: #ef4444; 
            --success: #10b981; /* ì—ë©”ë„ë“œ ê·¸ë¦° */
            --dark: #1e293b; 
            --gray-border: #e2e8f0; 
        }
        
        body { 
            font-family: -apple-system, sans-serif; 
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); 
            background-attachment: fixed;
            padding: 10px; margin: 0; color: #334155; 
            -webkit-tap-highlight-color: transparent; 
        }

        .container { max-width: 450px; margin: 0 auto; padding-bottom: 30px; }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px 5px; }
        .app-title { font-size: 1.35rem; color: var(--dark); font-weight: 800; margin: 0; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; }
        .setting-btn { background: white; border: 1px solid var(--gray-border); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; color: #64748b; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; }
        .setting-btn:active { transform: scale(0.95); background: #f8fafc; }

        /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            padding: 15px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            margin-bottom: 12px; 
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        #itemList { max-height: 60vh; overflow-y: auto; padding-right: 4px; margin-bottom: 15px; scroll-behavior: smooth; min-height: 100px; }
        #itemList::-webkit-scrollbar { width: 5px; }
        #itemList::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 150px; color: #94a3b8; font-size: 0.9rem; }
        
        .item-group { border: 1px solid rgba(0,0,0,0.03); border-radius: 14px; margin-bottom: 10px; overflow: hidden; background: #fff; position: relative; transition: all 0.2s; border-left: 6px solid var(--success); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .item-group:active { transform: scale(0.98); }
        
        .item-header { padding: 14px 45px 14px 15px; cursor: pointer; }
        .item-header .title-text::before { content: "âœ“"; color: var(--success); margin-right: 6px; font-weight: bold; }
        .sub-text { font-size: 0.78rem; color: #64748b; display: flex; align-items: center; gap: 5px; margin-top: 4px; }
        .info-val { color: #334155; font-weight: 600; }
        .info-val.team-list { color: var(--primary); }

        .remove-btn { position: absolute; right: 10px; top: 12px; background: #f1f5f9; color: #94a3b8; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }

        input[type="text"] { width: 100%; padding: 14px; margin: 5px 0; border: 1px solid var(--gray-border); border-radius: 12px; font-size: 0.95rem; background: #f8fafc; transition: all 0.2s; }
        input[type="text"]:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        .radio-item, .check-item { flex: 1; min-width: 80px; font-size: 0.8rem; background: #fff; border: 1px solid var(--gray-border); padding: 12px 5px; border-radius: 12px; cursor: pointer; transition: all 0.2s; color: #64748b; text-align: center; }
        .radio-item:has(input:checked), .check-item:has(input:checked) { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transform: translateY(-2px); }

        .save-btn { background: var(--success); color: white; }
        .add-btn { background: var(--dark); color: white; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(30, 41, 59, 0.2); }
        .clear-btn { background: transparent; color: #94a3b8; margin-bottom: 8px; font-size: 0.8rem; text-decoration: underline; }
        .calc-btn { background: var(--primary); color: white; box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3); margin-top: 10px; }
        .image-btn { background: #475569; color: white; margin-top: 15px; }

        /* [í•µì‹¬ ìˆ˜ì •] ì˜ìˆ˜ì¦ ìŠ¤íƒ€ì¼ ë¦¬í¬íŠ¸ */
        .result-box { 
            background: #ffffff; 
            color: #334155; 
            padding: 30px 20px; 
            border-radius: 4px; 
            display: none; 
            margin-top: 20px; 
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-top: 8px solid var(--primary);
        }
        /* ì˜ìˆ˜ì¦ ìƒë‹¨ ì§€ê·¸ì¬ê·¸ íš¨ê³¼ */
        .result-box::before {
            content: "";
            position: absolute;
            top: -14px; left: 0; width: 100%; height: 8px;
            background: linear-gradient(-45deg, transparent 4px, #ffffff 4px), 
                        linear-gradient(45deg, transparent 4px, #ffffff 4px);
            background-size: 8px 8px;
        }

        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.8rem; color: #475569; }
        .report-table th { border-bottom: 2px solid #f1f5f9; padding: 10px 4px; text-align: left; color: #94a3b8; font-weight: 600; }
        .report-table td { padding: 10px 4px; border-bottom: 1px solid #f8fafc; }
        
        .highlight { color: var(--primary); font-weight: 800; }
        .text-red { color: var(--danger); font-weight: bold; }
        .text-green { color: var(--success); font-weight: bold; }
        
        .guide-container { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px dashed #e2e8f0; }
        .guide-team { font-size: 0.9rem; margin-bottom: 6px; display: block; color: var(--dark); font-weight: 700; }
        .send-label { font-size: 0.7rem; color: #64748b; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; margin-right: 6px; }

        .settle-card { background: #f8fafc; border-radius: 12px; padding: 14px; margin-bottom: 10px; border-left: 4px solid; }
        .settle-card.send { border-color: var(--danger); }
        .settle-card.keep { border-color: var(--success); }
        .settle-text { font-size: 0.9rem; font-weight: 600; color: var(--dark); }
        
        .status-table { width: 100%; font-size: 0.78rem; margin-bottom: 15px; background: #f1f5f9; border-radius: 12px; padding: 15px; color: #475569; box-sizing: border-box; }
        .status-header { border-bottom: 1px solid #cbd5e1; padding-bottom: 8px; margin-bottom: 8px; font-weight: bold; color: #64748b; display: flex; justify-content: space-between; }
        .status-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.03); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #fff; width: 90%; max-width: 400px; padding: 25px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1 class="app-title">ğŸ§¾ íŒ€ ì •ì‚° ë¦¬í¬íŠ¸</h1>
        <button class="setting-btn" onclick="openSettings()">ì„¤ì •</button>
    </div>

    <div class="card">
        <div id="itemList"></div>
        <div class="button-group">
            <button class="add-btn" onclick="openItemModal()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
            <button class="clear-btn" onclick="clearAllItems()">ëª¨ë“  ë‚´ì—­ ì§€ìš°ê¸°</button>
            <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ í™•ì¸</button>
        </div>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box">
            <h3 style="color:var(--dark); margin-top:0; text-align:center; font-size:1.2rem; letter-spacing: 2px;">RECEIPT</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide"></div>
            <div id="privateSection"></div>
            <div style="text-align:center; margin-top:20px; color:#cbd5e1; font-size:0.7rem; letter-spacing: 3px;">THANK YOU</div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none;">
        <button class="image-btn" onclick="saveAsImage()">ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<!-- ëª¨ë‹¬ ë ˆì´ì–´ë“¤ (ë‚´ìš© ë™ì¼) -->
<div id="itemModal" class="modal-overlay">
    <div class="modal-card">
        <h3 class="modal-title" id="itemModalTitle" style="margin-top:0;">ì°¨ìˆ˜ ì •ë³´ ì…ë ¥</h3>
        <div id="itemModalBody"></div>
        <button class="save-btn" onclick="saveItemFromModal()" style="width:100%; padding:14px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size:1rem; margin-top:15px;">âœ” ì €ì¥í•˜ê¸°</button>
        <button class="modal-close-btn" onclick="closeItemModal()" style="width:100%; padding:12px; border:none; border-radius:12px; cursor:pointer; margin-top:8px; background:#f1f5f9; color:#64748b;">ë‹«ê¸°</button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-card">
        <h3 class="modal-title" style="margin-top:0;">âš™ï¸ ì„¤ì • ê´€ë¦¬</h3>
        <div class="setting-section" style="margin-bottom:20px;">
            <span style="font-size:0.85rem; font-weight:bold; margin-bottom:8px; display:block; color:#555;">ğŸ‘¥ ì „ì²´ íŒ€ ê´€ë¦¬</span>
            <div id="teamSettingList"></div>
            <button onclick="addTeamInput()" style="width:100%; padding:8px; background:#f1f5f9; border:none; border-radius:8px; margin-top:5px; font-size:0.8rem;">+ íŒ€ ì¶”ê°€</button>
        </div>
        <div class="setting-section" style="margin-bottom:20px;">
            <span style="font-size:0.85rem; font-weight:bold; margin-bottom:8px; display:block; color:#555;">ğŸ‘¤ ìš°ë¦¬ íŒ€ì› (ë‚´ë¶€ìš©)</span>
            <div id="memberSettingList"></div>
            <button onclick="addMemberInput()" style="width:100%; padding:8px; background:#f1f5f9; border:none; border-radius:8px; margin-top:5px; font-size:0.8rem;">+ íŒ€ì› ì¶”ê°€</button>
        </div>
        <button class="calc-btn" onclick="saveSettings()" style="width:100%; margin-top:10px;">ì €ì¥í•˜ê³  ë‹«ê¸°</button>
        <button onclick="factoryReset()" style="width:100%; padding:10px; margin-top:20px; background:#fff1f2; color:#e11d48; border:1px solid #fecdd3; border-radius:10px; font-size:0.75rem;">ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>
</div>

<script>
    /* ë¡œì§ ë¶€ë¶„ì€ v36ê³¼ 100% ë™ì¼, ë‹¨ calculate() ë‚´ ì»¬ëŸ¬ê°’ë§Œ ì˜ìˆ˜ì¦ ìŠ¤íƒ€ì¼ì— ë§ê²Œ ì¼ë¶€ ì¡°ì • */
    const defaultConfig = {
        teams: [
            { id: 'teamA', name: "AíŒ€(ì˜ì„±,ì§€í˜œ)", isMyTeam: false },
            { id: 'teamB', name: "BíŒ€(í˜„ìˆ˜,ë¯¸ì˜)", isMyTeam: false },
            { id: 'teamC', name: "CíŒ€(ì§€í›ˆ,ì€í˜œ)", isMyTeam: true }
        ],
        members: ["ì§€í›ˆ", "ì€í˜œ"],
        truncationUnit: 1
    };

    let appConfig = JSON.parse(localStorage.getItem('appConfig')) || defaultConfig;
    let currentEditingIndex = -1;

    window.onload = function() { loadData(); }

    function openSettings() { renderSettingsUI(); document.getElementById('settingsModal').style.display = 'flex'; }
    function renderSettingsUI() {
        const teamList = document.getElementById('teamSettingList');
        teamList.innerHTML = '';
        appConfig.teams.forEach((team, idx) => {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
            div.innerHTML = `
                <input type="radio" name="myTeamSelect" ${team.isMyTeam ? 'checked' : ''} onclick="updateMyTeam(${idx})">
                <input type="text" value="${team.name}" onchange="appConfig.teams[${idx}].name = this.value" style="margin:0; padding:8px; flex:1;">
                <button onclick="removeTeam(${idx})" style="background:#fee2e2; border:none; color:#ef4444; border-radius:8px; width:35px;">Ã—</button>
            `;
            teamList.appendChild(div);
        });
        const memberList = document.getElementById('memberSettingList');
        memberList.innerHTML = '';
        appConfig.members.forEach((mem, idx) => {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
            div.innerHTML = `
                <input type="text" value="${mem}" onchange="appConfig.members[${idx}] = this.value" style="margin:0; padding:8px; flex:1;">
                <button onclick="removeMember(${idx})" style="background:#fee2e2; border:none; color:#ef4444; border-radius:8px; width:35px;">Ã—</button>
            `;
            memberList.appendChild(div);
        });
    }

    function addTeamInput() { appConfig.teams.push({ id: `team${Date.now()}`, name: "ìƒˆíŒ€", isMyTeam: false }); renderSettingsUI(); }
    function removeTeam(idx) { appConfig.teams.splice(idx, 1); renderSettingsUI(); }
    function updateMyTeam(idx) { appConfig.teams.forEach((t, i) => t.isMyTeam = (i === idx)); }
    function addMemberInput() { appConfig.members.push("ìƒˆë©¤ë²„"); renderSettingsUI(); }
    function removeMember(idx) { appConfig.members.splice(idx, 1); renderSettingsUI(); }
    function saveSettings() { localStorage.setItem('appConfig', JSON.stringify(appConfig)); location.reload(); }
    function factoryReset() { if(confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) { localStorage.clear(); location.reload(); } }

    function loadData() {
        const savedData = localStorage.getItem('settlementData');
        const list = document.getElementById('itemList');
        list.innerHTML = ""; 
        if (savedData && JSON.parse(savedData).length > 0) { 
            JSON.parse(savedData).forEach((item, idx) => renderItemSummary(item, idx)); 
        } else { list.innerHTML = `<div class="empty-state">ì•„ì§ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; }
    }

    function renderItemSummary(data, index) {
        const list = document.getElementById('itemList');
        if (list.querySelector('.empty-state')) list.innerHTML = "";
        const div = document.createElement('div');
        div.className = 'item-group';
        const name = data.name || (index + 1) + "ì°¨";
        const amt = data.amount || "0";
        const payer = data.payer || "ê²°ì œì ë¯¸ì„ íƒ";
        const checkedTeams = appConfig.teams.filter(t => data.teams[t.id] !== false).map(t => t.name.split('(')[0]);
        div.innerHTML = `
            <button class="remove-btn" onclick="event.stopPropagation(); removeItem(${index})">Ã—</button>
            <div class="item-header" onclick="openItemModal(${index})">
                <span style="font-weight:bold; font-size:0.95rem;" class="title-text">${name} (${amt}ì›)</span>
                <div class="sub-text">ğŸ’³ <span class="info-val">${payer}</span> <span style="color:#e2e8f0">|</span> ğŸ‘¥ <span class="info-val team-list">${checkedTeams.join(',')}</span></div>
            </div>
        `;
        list.appendChild(div);
    }

    function openItemModal(index = -1) {
        currentEditingIndex = index;
        const modal = document.getElementById('itemModal');
        const body = document.getElementById('itemModalBody');
        let data = (index !== -1) ? JSON.parse(localStorage.getItem('settlementData'))[index] : { name: '', amount: '', payer: '', teams: {} };
        const otherTeams = appConfig.teams.filter(t => !t.isMyTeam);
        let payerHtml = otherTeams.map(t => `<label class="radio-item"><input type="radio" name="modalPayer" value="${t.name}" ${data.payer === t.name ? 'checked' : ''} style="display:none">${t.name}</label>`).join('');
        payerHtml += appConfig.members.map(m => `<label class="radio-item"><input type="radio" name="modalPayer" value="${m}" ${data.payer === m ? 'checked' : ''} style="display:none">${m}</label>`).join('');
        const teamCheckHtml = appConfig.teams.map(t => `<label class="check-item"><input type="checkbox" class="modal-team-check" value="${t.id}" ${data.teams[t.id] !== false ? 'checked' : ''} style="display:none">${t.name}</label>`).join('');
        body.innerHTML = `
            <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: ì €ë…ì‹ì‚¬)" id="modalItemName" value="${data.name || ''}">
            <input type="text" placeholder="ê¸ˆì•¡" id="modalItemAmount" inputmode="numeric" value="${data.amount || ''}" oninput="formatAmount(this)">
            <span style="font-size:0.8rem; font-weight:bold; margin-top:12px; display:block; color:#64748b;">ğŸ’³ ê²°ì œì</span>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">${payerHtml}</div>
            <span style="font-size:0.8rem; font-weight:bold; margin-top:12px; display:block; color:#64748b;">ğŸ‘¥ ì°¸ì—¬íŒ€</span>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">${teamCheckHtml}</div>
        `;
        modal.style.display = 'flex';
    }

    function closeItemModal() { document.getElementById('itemModal').style.display = 'none'; }
    function formatAmount(obj) { let v = obj.value.replace(/[^0-9]/g, ""); obj.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

    function saveItemFromModal() {
        const amt = document.getElementById('modalItemAmount').value;
        const payerLabel = document.querySelector('input[name="modalPayer"]:checked')?.parentElement.textContent;
        if (!amt || !payerLabel) return alert("í•„ìˆ˜í•­ëª© ì…ë ¥!");
        const teamChecks = {};
        document.querySelectorAll('.modal-team-check').forEach(cb => { teamChecks[cb.value] = cb.checked; });
        const newItem = { name: document.getElementById('modalItemName').value, amount: amt, payer: payerLabel, teams: teamChecks };
        let saved = JSON.parse(localStorage.getItem('settlementData') || "[]");
        if (currentEditingIndex === -1) saved.push(newItem); else saved[currentEditingIndex] = newItem;
        localStorage.setItem('settlementData', JSON.stringify(saved));
        closeItemModal(); loadData();
    }

    function removeItem(idx) { if(confirm("ì‚­ì œ?")) { let s = JSON.parse(localStorage.getItem('settlementData')); s.splice(idx,1); localStorage.setItem('settlementData', JSON.stringify(s)); loadData(); } }
    function clearAllItems() { if(confirm("ì „ì²´ ì‚­ì œ?")) { localStorage.removeItem('settlementData'); location.reload(); } }
    function applyTruncate(amt) { const u = appConfig.truncationUnit || 1; return Math.floor(Math.round(amt) / u) * u; }

    function calculate() {
        const items = JSON.parse(localStorage.getItem('settlementData') || "[]");
        if(items.length === 0) return alert("ë‚´ì—­ ì—†ìŒ");
        let total = 0; let teamPaid = {}; let teamSpent = {}; let memberPaid = {};
        appConfig.teams.forEach(t => { teamPaid[t.id] = 0; teamSpent[t.id] = 0; });
        appConfig.members.forEach(m => { memberPaid[m] = 0; });
        const myTeam = appConfig.teams.find(t => t.isMyTeam);

        let tableHtml = `<table class="report-table"><tr><th>í•­ëª©</th><th>ê²°ì œì</th><th>ê¸ˆì•¡</th></tr>`;
        items.forEach((item, idx) => {
            const amt = Number(item.amount.replace(/,/g,''));
            total += amt;
            tableHtml += `<tr><td>${item.name || (idx+1)+'ì°¨'}</td><td>${item.payer}</td><td>${amt.toLocaleString()}</td></tr>`;
            if (appConfig.members.includes(item.payer)) { teamPaid[myTeam.id] += amt; memberPaid[item.payer] += amt; }
            else { const pt = appConfig.teams.find(t => t.name === item.payer); if (pt) teamPaid[pt.id] += amt; }
            const active = Object.keys(item.teams).filter(tid => item.teams[tid]);
            if (active.length > 0) { const per = amt / active.length; active.forEach(tid => { if(teamSpent[tid]!==undefined) teamSpent[tid]+=per; });}
        });

        let diffs = appConfig.teams.map(t => ({ id: t.id, name: t.name, balance: teamPaid[t.id] - teamSpent[t.id] }));
        let msg = "";
        diffs.filter(d => d.balance < -1).forEach(debtor => {
            let d_amt = Math.abs(debtor.balance);
            diffs.filter(c => c.balance > 1).forEach(creditor => {
                if (d_amt <= 0 || creditor.balance <= 0) return;
                let trade = Math.min(d_amt, creditor.balance);
                msg += `<div class="guide-container"><span class="guide-team">ğŸ’° ${debtor.name} â†’ ${creditor.name}</span><div style="display:flex; align-items:center;"><span class="send-label">ì†¡ê¸ˆì•¡</span><span class="highlight">${applyTruncate(trade).toLocaleString()}ì›</span></div></div>`;
                d_amt -= trade; creditor.balance -= trade;
            });
        });

        document.getElementById('reportHeader').innerHTML = `${tableHtml}</table><div style="text-align:right; margin-bottom:20px; font-weight:800; font-size:1.1rem; color:var(--dark);">TOTAL: ${total.toLocaleString()}ì›</div>`;
        document.getElementById('reportGuide').innerHTML = `<div style="font-size:0.75rem; color:#94a3b8; margin-bottom:10px; font-weight:bold;">[íŒ€ ê°„ ì •ì‚° ê²°ê³¼]</div><div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #f1f5f9;">${msg || "ì •ì‚° ì™„ë£Œ"}</div>`;
        
        const perMember = teamSpent[myTeam.id] / appConfig.members.length;
        let statusHtml = `<div class="status-header"><span>ì´ë¦„</span><span>ë‚¸ëˆ / ê²°ê³¼</span></div>`;
        let mBal = {};
        appConfig.members.forEach(m => {
            const paid = memberPaid[m]; const bal = paid - perMember; mBal[m] = bal;
            const color = bal >= 0 ? 'text-green' : 'text-red';
            statusHtml += `<div class="status-row"><span>${m}</span><span class="${color}">${Math.round(paid).toLocaleString()} / ${bal > 0 ? '+' : ''}${applyTruncate(bal).toLocaleString()}</span></div>`;
        });

        let step1 = "";
        let givers = Object.keys(mBal).filter(m => mBal[m] < -1);
        let receivers = Object.keys(mBal).filter(m => mBal[m] > 1);
        givers.forEach(g => {
            receivers.forEach(r => {
                let debt = Math.abs(mBal[g]); let credit = mBal[r];
                if (debt < 1 || credit < 1) return;
                let trade = Math.min(debt, credit);
                mBal[g] += trade; mBal[r] -= trade;
                step1 += `<div class="settle-card send"><div class="settle-text">${g} â†’ ${r}: <span class="highlight">${applyTruncate(trade).toLocaleString()}ì›</span></div></div>`;
            });
        });

        document.getElementById('privateSection').innerHTML = `<hr style="border:none; border-top:2px dashed #f1f5f9; margin:25px 0;"><div style="font-size:0.75rem; color:#94a3b8; margin-bottom:10px; font-weight:bold;">[ìš°ë¦¬ íŒ€ ë‚´ë¶€ ì •ì‚°]</div><div class="status-table">${statusHtml}</div>${step1 || "ë‚´ë¶€ ì •ì‚° ì—†ìŒ"}`;
        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function saveAsImage() {
        html2canvas(document.getElementById('captureArea'), { backgroundColor: "#f1f5f9", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì •ì‚°ë¦¬í¬íŠ¸_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL(); link.click();
        });
    }
</script>
</body>
</html>
