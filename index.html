<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒ€ ì •ì‚° ì–´í”Œ (Final V37)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* [Design Update: 2026-02-17-v37] Floating Cards & Dark/Light System */
        :root {
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --primary: #4a90e2;
            --success: #00b894;
            --danger: #ff7675;
            --shadow: 0 10px 25px rgba(0,0,0,0.05);
            --header-bg: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #121212;
                --card-bg: #1e1e1e;
                --text-main: #e0e0e0;
                --text-sub: #a0a0a0;
                --primary: #5da2f2;
                --success: #00d2a0;
                --danger: #ff8e8d;
                --shadow: 0 10px 30px rgba(0,0,0,0.3);
                --header-bg: #1e1e1e;
            }
        }

        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); 
            padding: 20px 15px; 
            margin: 0; 
            color: var(--text-main);
            transition: background 0.3s ease;
        }

        .container { max-width: 450px; margin: 0 auto; }

        /* í—¤ë” ë””ìì¸ */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 0 5px; }
        .app-title { font-size: 1.4rem; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        .setting-btn { background: var(--card-bg); border: none; padding: 8px 16px; border-radius: 12px; font-size: 0.85rem; cursor: pointer; color: var(--text-sub); font-weight: 600; box-shadow: var(--shadow); }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼: í”Œë¡œíŒ… ì¹´ë“œ */
        #itemList { margin-bottom: 20px; }
        .item-group { 
            background: var(--card-bg); 
            border-radius: 20px; 
            margin-bottom: 15px; 
            box-shadow: var(--shadow);
            position: relative; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(0,0,0,0.03);
            overflow: hidden;
        }
        .item-group:active { transform: scale(0.98); }

        /* ì ‘í˜”ì„ ë•Œì˜ íŠ¹ë³„í•œ ìŠ¤íƒ€ì¼ */
        .item-group.collapsed { border-left: 5px solid var(--success); }
        .item-group.collapsed .title-text { color: var(--text-main); }

        .item-header { padding: 18px 20px; cursor: pointer; }
        .title-text { font-size: 1rem; font-weight: 700; display: block; margin-bottom: 6px; }
        
        /* í—¤ë” í•œ ì¤„ ë ˆì´ì•„ì›ƒ ìœ ì§€ */
        .sub-text { font-size: 0.8rem; color: var(--text-sub); display: flex; align-items: center; gap: 6px; }
        .info-val { color: var(--text-main); font-weight: 600; }
        .divider { opacity: 0.3; margin: 0 2px; }

        .item-body { padding: 20px; background: rgba(0,0,0,0.02); border-top: 1px solid rgba(0,0,0,0.05); }
        .collapsed .item-body { display: none; }

        /* ì…ë ¥ í¼ ë””ìì¸ */
        input[type="text"] { 
            width: 100%; padding: 14px; margin: 8px 0; 
            border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; 
            background: var(--card-bg); color: var(--text-main);
            font-size: 1rem; box-sizing: border-box;
        }
        .label-text { font-size: 0.85rem; font-weight: 700; margin-top: 15px; display: block; color: var(--primary); }

        /* ë²„íŠ¼ ë° ê¸°íƒ€ ìš”ì†Œ */
        .remove-btn { position: absolute; right: 12px; top: 12px; background: rgba(255,118,117,0.1); color: var(--danger); width: 28px; height: 28px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .flex-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .radio-item, .check-item { 
            flex: 1; min-width: 80px; padding: 12px 8px; border-radius: 12px; 
            background: var(--card-bg); border: 1px solid rgba(0,0,0,0.1); 
            color: var(--text-sub); font-size: 0.85rem; font-weight: 600;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .radio-item input, .check-item input { display: none; }
        .radio-item:has(input:checked), .check-item:has(input:checked) { 
            background: var(--primary); color: #fff; border-color: var(--primary); 
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .button-group { margin-top: 25px; }
        button { width: 100%; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .add-btn { background: var(--text-main); color: var(--card-bg); padding: 16px; font-size: 1rem; margin-bottom: 12px; box-shadow: var(--shadow); }
        .calc-btn { background: var(--primary); color: white; padding: 18px; font-size: 1.1rem; box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3); }
        .clear-btn { background: transparent; color: var(--text-sub); font-size: 0.85rem; padding: 10px; margin-top: 10px; text-decoration: underline; }

        /* ê²°ê³¼ ë¦¬í¬íŠ¸ */
        .result-box { background: #2d3436; color: #fff; padding: 25px; border-radius: 24px; display: none; margin-top: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.8rem; }
        .report-table th { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px 5px; text-align: left; color: #888; }
        .report-table td { padding: 12px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .highlight { color: #f39c12; font-weight: bold; }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-card { background: var(--card-bg); width: 90%; max-width: 400px; padding: 25px; border-radius: 24px; box-shadow: var(--shadow); color: var(--text-main); }
        
        .empty-state { padding: 60px 20px; text-align: center; color: var(--text-sub); }
        .empty-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.3; }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1 class="app-title">ğŸ§¾ ì •ì‚° í”Œë¡œíŒ…</h1>
        <button class="setting-btn" onclick="openSettings()">ì„¤ì •</button>
    </div>

    <div id="itemList"></div>
    
    <div class="button-group">
        <button class="add-btn" onclick="addNewItem()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
        <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ í™•ì¸</button>
        <button class="clear-btn" onclick="clearAllItems()">ëª¨ë“  ë‚´ì—­ ì§€ìš°ê¸°</button>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box">
            <h3 style="color:white; margin-top:0; text-align:center; font-size:1.1rem; letter-spacing: 1px;">ğŸ“Š ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide"></div>
            <div id="privateSection"></div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none; margin-top: 15px;">
        <button style="background: var(--success); color:white; padding: 15px;" onclick="saveAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="margin-top:0;">âš™ï¸ ì„¤ì •</h3>
        <div id="teamSettingList"></div>
        <button class="add-btn" style="padding:10px; font-size:0.8rem; margin-top:10px;" onclick="addTeamInput()">+ íŒ€ ì¶”ê°€</button>
        <hr style="opacity:0.1; margin:20px 0;">
        <div id="memberSettingList"></div>
        <button class="add-btn" style="padding:10px; font-size:0.8rem; margin-top:10px;" onclick="addMemberInput()">+ íŒ€ì› ì¶”ê°€</button>
        <button class="calc-btn" style="margin-top:25px;" onclick="saveSettings()">ì €ì¥ ë° ë‹«ê¸°</button>
    </div>
</div>

<script>
    /* ê¸°ëŠ¥ ë¡œì§ì€ ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (V36ê³¼ ë™ì¼) */
    const defaultConfig = {
        teams: [
            { id: 'teamA', name: "AíŒ€(ì˜ì„±,ì§€í˜œ)", isMyTeam: false },
            { id: 'teamB', name: "BíŒ€(í˜„ìˆ˜,ë¯¸ì˜)", isMyTeam: false },
            { id: 'teamC', name: "CíŒ€(ì§€í›ˆ,ì€í˜œ)", isMyTeam: true }
        ],
        members: ["ì§€í›ˆ", "ì€í˜œ"],
        truncationUnit: 1
    };

    let appConfig = JSON.parse(localStorage.getItem('appConfig')) || defaultConfig;

    window.onload = function() { loadData(); }

    function openSettings() { renderSettingsUI(); document.getElementById('settingsModal').style.display = 'flex'; }
    
    function renderSettingsUI() {
        const teamList = document.getElementById('teamSettingList');
        teamList.innerHTML = '<span style="font-size:0.8rem; font-weight:bold;">ğŸ‘¥ ì „ì²´ íŒ€ ê´€ë¦¬</span>';
        appConfig.teams.forEach((team, idx) => {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginTop = '5px';
            div.innerHTML = `<input type="radio" name="myTeamSelect" ${team.isMyTeam ? 'checked' : ''} onclick="updateMyTeam(${idx})"><input type="text" value="${team.name}" onchange="appConfig.teams[${idx}].name = this.value" style="margin:0; padding:8px;">`;
            teamList.appendChild(div);
        });
        const memberList = document.getElementById('memberSettingList');
        memberList.innerHTML = '<span style="font-size:0.8rem; font-weight:bold;">ğŸ‘¤ ìš°ë¦¬ íŒ€ì› ê´€ë¦¬</span>';
        appConfig.members.forEach((mem, idx) => {
            const div = document.createElement('div');
            div.style.marginTop = '5px';
            div.innerHTML = `<input type="text" value="${mem}" onchange="appConfig.members[${idx}] = this.value" style="margin:0; padding:8px;">`;
            memberList.appendChild(div);
        });
    }

    function addTeamInput() { appConfig.teams.push({ id: `team${Date.now()}`, name: "ìƒˆë¡œìš´íŒ€", isMyTeam: false }); renderSettingsUI(); }
    function addMemberInput() { appConfig.members.push("ìƒˆíŒ€ì›"); renderSettingsUI(); }
    function updateMyTeam(idx) { appConfig.teams.forEach((t, i) => t.isMyTeam = (i === idx)); }
    function saveSettings() { localStorage.setItem('appConfig', JSON.stringify(appConfig)); location.reload(); }

    function loadData() {
        const savedData = localStorage.getItem('settlementData');
        const list = document.getElementById('itemList');
        list.innerHTML = ""; 
        if (savedData && JSON.parse(savedData).length > 0) { JSON.parse(savedData).forEach((item) => renderItem(item)); } 
        else { list.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‚</div>ì•„ì§ ì¶”ê°€ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; }
    }

    function renderItem(data = null) {
        const list = document.getElementById('itemList');
        if (list.querySelector('.empty-state')) list.innerHTML = "";
        const tempId = Date.now() + Math.random();
        const div = document.createElement('div');
        div.className = `item-group ${data?.collapsed ? 'collapsed' : ''}`;
        div.setAttribute('data-id', tempId);
        
        const otherTeams = appConfig.teams.filter(t => !t.isMyTeam);
        let payerOptionsHtml = otherTeams.map(t => `<label class="radio-item"><input type="radio" name="payer_${tempId}" value="${t.name}" ${data?.payer === t.name ? 'checked' : ''} onchange="updateHeader(this)">${t.name}</label>`).join('');
        payerOptionsHtml += appConfig.members.map(m => `<label class="radio-item"><input type="radio" name="payer_${tempId}" value="${m}" ${data?.payer === m ? 'checked' : ''} onchange="updateHeader(this)">${m}</label>`).join('');
        const teamCheckHtml = appConfig.teams.map(t => `<label class="check-item"><input type="checkbox" class="team-check" value="${t.id}" data-name="${t.name}" ${data?.teams?.[t.id] !== false ? 'checked' : ''} onchange="updateHeader(this)">${t.name}</label>`).join('');

        div.innerHTML = `
            <button class="remove-btn" onclick="removeItem(this)">Ã—</button>
            <div class="item-header" onclick="toggleItem(this)">
                <span class="title-text">...</span>
                <div class="sub-text"></div>
            </div>
            <div class="item-body">
                <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: ê°ìíƒ•)" class="item-name" value="${data?.name || ''}" oninput="updateHeader(this)">
                <input type="text" placeholder="ê²°ì œ ê¸ˆì•¡" class="item-amount" inputmode="numeric" value="${data?.amount || ''}" oninput="formatAmount(this); updateHeader(this)">
                <span class="label-text">ğŸ’³ ê²°ì œì</span><div class="flex-group">${payerOptionsHtml}</div>
                <span class="label-text">ğŸ‘¥ ì°¸ì—¬ íŒ€</span><div class="flex-group">${teamCheckHtml}</div>
                <button class="add-btn" style="margin-top:20px; background:var(--success);" onclick="saveAndCollapse(this)">âœ” ì €ì¥ ë° ì ‘ê¸°</button>
            </div>`;
        list.appendChild(div);
        updateHeader(div.querySelector('.item-name'));
    }

    function updateHeader(element) {
        const g = element.closest('.item-group');
        const nameInput = g.querySelector('.item-name').value;
        const amt = g.querySelector('.item-amount').value || "0";
        const payer = g.querySelector(`input[type="radio"]:checked`)?.parentElement.textContent || "ë¯¸ì„ íƒ";
        const checkedTeams = Array.from(g.querySelectorAll('.team-check:checked')).map(cb => cb.getAttribute('data-name').split('(')[0]);
        const allGroups = Array.from(document.querySelectorAll('.item-group'));
        const index = allGroups.indexOf(g) + 1;
        g.querySelector('.title-text').innerText = `${nameInput || index + "ì°¨"} (${amt}ì›)`;
        g.querySelector('.sub-text').innerHTML = `ğŸ’³ ${payer} <span class="divider">/</span> ğŸ‘¥ ${checkedTeams.join(',') || 'ì—†ìŒ'}`;
        saveToLocal();
    }

    function formatAmount(obj) { let value = obj.value.replace(/[^0-9]/g, ""); obj.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function addNewItem() { renderItem(); }
    function clearAllItems() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem('settlementData'); location.reload(); } }
    function saveAndCollapse(btn) { btn.closest('.item-group').classList.add('collapsed'); saveToLocal(); }
    function toggleItem(header) { header.closest('.item-group').classList.toggle('collapsed'); }
    function removeItem(btn) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { btn.closest('.item-group').remove(); saveToLocal(); } }
    
    function saveToLocal() {
        const items = [];
        document.querySelectorAll('.item-group').forEach(g => {
            const tempId = g.getAttribute('data-id');
            const teamChecks = {};
            g.querySelectorAll('.team-check').forEach(cb => { teamChecks[cb.value] = cb.checked; });
            items.push({ name: g.querySelector('.item-name').value, amount: g.querySelector('.item-amount').value, payer: g.querySelector(`input[name="payer_${tempId}"]:checked`)?.parentElement.textContent || "", teams: teamChecks, collapsed: g.classList.contains('collapsed') });
        });
        localStorage.setItem('settlementData', JSON.stringify(items));
    }

    function calculate() {
        saveToLocal();
        const items = JSON.parse(localStorage.getItem('settlementData') || "[]");
        if(items.length === 0) return alert("ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        
        let total = 0;
        let teamPaid = {}; let teamSpent = {}; let memberPaid = {};
        appConfig.teams.forEach(t => { teamPaid[t.id] = 0; teamSpent[t.id] = 0; });
        appConfig.members.forEach(m => { memberPaid[m] = 0; });

        let tableHtml = `<table class="report-table"><tr><th>í•­ëª©</th><th>ê²°ì œì</th><th>ê¸ˆì•¡</th></tr>`;
        const myTeam = appConfig.teams.find(t => t.isMyTeam);

        items.forEach((item, idx) => {
            const amt = Number(item.amount.replace(/,/g,''));
            total += amt;
            tableHtml += `<tr><td>${item.name || (idx+1)+'ì°¨'}</td><td>${item.payer}</td><td>${amt.toLocaleString()}ì›</td></tr>`;

            if (appConfig.members.includes(item.payer)) {
                teamPaid[myTeam.id] += amt;
                memberPaid[item.payer] += amt;
            } else {
                const payerTeam = appConfig.teams.find(t => t.name === item.payer);
                if (payerTeam) teamPaid[payerTeam.id] += amt;
            }

            const activeTeams = Object.keys(item.teams).filter(tid => item.teams[tid]);
            if (activeTeams.length > 0) {
                const perTeamCost = amt / activeTeams.length;
                activeTeams.forEach(tid => { if (teamSpent[tid] !== undefined) teamSpent[tid] += perTeamCost; });
            }
        });

        let diffs = appConfig.teams.map(t => ({ id: t.id, name: t.name, balance: teamPaid[t.id] - teamSpent[t.id] }));
        let msg = "";
        diffs.filter(d => d.balance < -1).forEach(debtor => {
            let debt = Math.abs(debtor.balance);
            diffs.filter(c => c.balance > 1).forEach(creditor => {
                if (debt <= 0 || creditor.balance <= 0) return;
                let amount = Math.min(debt, creditor.balance);
                msg += `<div style="margin-bottom:10px;">ğŸ’° ${debtor.name} â†’ ${creditor.name}: <span class="highlight">${Math.floor(amount).toLocaleString()}ì›</span></div>`;
                debt -= amount; creditor.balance -= amount;
            });
        });

        document.getElementById('reportHeader').innerHTML = tableHtml + `<div style="text-align:right; margin:15px 0; padding:10px; background:rgba(243,156,18,0.1); border-radius:12px; border:1px dashed #f39c12;"><span style="color:#f39c12; font-weight:bold;">ì´ í•©ê³„: ${total.toLocaleString()}ì›</span></div>`;
        document.getElementById('reportGuide').innerHTML = `<div style="background:#3d4446; padding:15px; border-radius:15px; font-size:0.9rem;">${msg || "ì£¼ê³ ë°›ì„ ëˆ ì—†ìŒ"}</div>`;
        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
    }

    function saveAsImage() {
        html2canvas(document.getElementById('captureArea'), { backgroundColor: "#121212" }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ì •ì‚°ë¦¬í¬íŠ¸.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>
