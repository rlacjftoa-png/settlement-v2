<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒ€ ì •ì‚° ì–´í”Œ (Final V33.4)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* [Update: 2026-02-17-v33.4] ëª¨ë“  ê¸°ëŠ¥ í†µí•© ë° ì •ì‚° ë¡œì§ ë³µêµ¬ */
        :root { --primary: #4a90e2; --bg: #f2f4f7; --card-bg: #ffffff; --danger: #ff4d4f; --success: #28a745; --dark: #2d3436; --gray-border: #dfe6e9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 450px; margin: 0 auto; padding-bottom: 30px; }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px 5px; }
        .app-title { font-size: 1.25rem; color: #333; font-weight: 800; margin: 0; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .setting-btn { background: #e9ecef; border: none; padding: 7px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; color: #555; font-weight: 600; }

        .card { background: var(--card-bg); padding: 15px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 12px; }
        
        #itemList { max-height: 65vh; overflow-y: auto; padding-right: 4px; margin-bottom: 15px; scroll-behavior: smooth; min-height: 100px; }
        #itemList::-webkit-scrollbar { width: 5px; }
        #itemList::-webkit-scrollbar-thumb { background: #d1d8e0; border-radius: 10px; }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 150px; color: #aaa; font-size: 0.9rem; text-align: center; }
        .item-group { border: 1px solid #eee; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; position: relative; transition: all 0.3s ease; }
        .item-group.collapsed { border-left: 6px solid var(--success); background: #fafbfc; }
        .item-header { padding: 12px 45px 12px 15px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; }
        .sub-text { font-size: 0.75rem; color: #666; }
        .info-label { font-weight: bold; color: #888; }
        .info-val.team-list { color: var(--primary); }
        .item-body { padding: 15px; border-top: 1px solid #eee; background: #fdfdfd; }
        .collapsed .item-body { display: none; }
        
        .remove-btn { position: absolute; right: 5px; top: 8px; background: #f1f3f5; color: #adb5bd; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; z-index: 5; }

        input[type="text"] { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 0.95rem; }
        .label-text { font-size: 0.8rem; font-weight: bold; margin-top: 12px; margin-bottom: 6px; display: block; color: #555; }
        .flex-group { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
        .radio-item, .check-item { flex: 1; min-width: 70px; font-size: 0.8rem; background: #fff; border: 1px solid var(--gray-border); padding: 12px 5px; border-radius: 10px; cursor: pointer; text-align: center; color: #888; }
        .radio-item input, .check-item input { display: none; }
        .radio-item:has(input:checked), .check-item:has(input:checked) { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .save-btn { background: var(--success); color: white; margin-top: 15px; }
        .add-btn { background: #495057; color: white; margin-bottom: 8px; }
        .clear-btn { background: #f1f3f5; color: #adb5bd; margin-bottom: 8px; font-size: 0.8rem; }
        .calc-btn { background: var(--primary); color: white; margin-top: 5px; }
        .image-btn { background: #6c5ce7; color: white; margin-top: 15px; }

        .result-box { background: var(--dark); color: #fff; padding: 20px; border-radius: 18px; display: none; margin-top: 15px; }
        .report-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.7rem; color: #ddd; table-layout: fixed; }
        .report-table th { border-bottom: 1px solid #555; padding: 8px 4px; text-align: left; color: #aaa; }
        .report-table td { padding: 8px 4px; border-bottom: 1px solid #444; word-break: break-all; }
        .highlight { color: #f39c12; font-weight: bold; }
        .text-red { color: #ff6b6b; font-weight: bold; }
        .text-green { color: #2ecc71; font-weight: bold; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #fff; width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; max-height: 80vh; overflow-y: auto; }
        
        .settle-card { background: rgba(255,255,255,0.08); border-radius: 10px; padding: 12px; margin-bottom: 8px; border-left: 4px solid; }
        .settle-card.send { border-color: var(--danger); }
        .settle-card.keep { border-color: var(--success); }
        .status-table { width: 100%; font-size: 0.75rem; margin-bottom: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; color: #ccc; }
        .status-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #555; padding: 4px 0; }
        .col-name { font-weight: bold; color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1 class="app-title">ğŸ§¾ íŒ€ ì •ì‚° ì–´í”Œ</h1>
        <button class="setting-btn" onclick="openSettings()">ì„¤ì •</button>
    </div>

    <div class="card">
        <div id="itemList"></div>
        <div class="button-group">
            <button class="add-btn" onclick="addNewItem()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
            <button class="clear-btn" onclick="clearAllItems()">ğŸ—‘ï¸ ëª¨ë“  ë‚´ì—­ ì§€ìš°ê¸°</button>
            <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ í™•ì¸</button>
        </div>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box card">
            <h3 style="color:white; margin-top:0; text-align:center;">ğŸ“Š ìµœì¢… ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide"></div>
            <div id="privateSection"></div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none;">
        <button class="image-btn" onclick="saveAsImage()">ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="margin-top:0;">âš™ï¸ ì„¤ì • ê´€ë¦¬</h3>
        <span class="label-text">ğŸ‘¥ íŒ€ ê´€ë¦¬</span>
        <div id="teamSettingList"></div>
        <button onclick="addTeamInput()" style="background:#eee; padding:8px; margin-top:5px;">+ íŒ€ ì¶”ê°€</button>
        <span class="label-text">ğŸ‘¤ ìš°ë¦¬ íŒ€ì›</span>
        <div id="memberSettingList"></div>
        <button onclick="addMemberInput()" style="background:#eee; padding:8px; margin-top:5px;">+ íŒ€ì› ì¶”ê°€</button>
        <span class="label-text">ğŸ’° ì ˆì‚¬ ë‹¨ìœ„</span>
        <div id="truncOptions" class="flex-group"></div>
        <button onclick="saveSettings()" style="background:var(--dark); color:#fff; margin-top:20px;">ì €ì¥í•˜ê³  ë‹«ê¸°</button>
    </div>
</div>

<script>
    const defaultConfig = {
        teams: [
            { id: 'teamA', name: "AíŒ€(ì˜ì„±,ì§€í˜œ)", isMyTeam: false },
            { id: 'teamB', name: "BíŒ€(í˜„ìˆ˜,ë¯¸ì˜)", isMyTeam: false },
            { id: 'teamC', name: "CíŒ€(ì§€í›ˆ,ì€í˜œ)", isMyTeam: true }
        ],
        members: ["ì§€í›ˆ", "ì€í˜œ"],
        truncationUnit: 1
    };

    let appConfig = JSON.parse(localStorage.getItem('appConfig')) || defaultConfig;

    window.onload = function() { loadData(); }

    function loadData() {
        const savedData = localStorage.getItem('settlementData');
        const list = document.getElementById('itemList');
        list.innerHTML = ""; 
        if (savedData && JSON.parse(savedData).length > 0) {
            JSON.parse(savedData).forEach((item) => renderItem(item));
        } else {
            list.innerHTML = `<div class="empty-state">ğŸ“ ë‚´ì—­ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</div>`;
        }
    }

    function renderItem(data = null) {
        const list = document.getElementById('itemList');
        if (list.querySelector('.empty-state')) list.innerHTML = "";
        const tempId = data?.tempId || Date.now() + Math.random();
        const div = document.createElement('div');
        div.className = `item-group ${data?.collapsed ? 'collapsed' : ''}`;
        div.setAttribute('data-id', tempId);
        
        const otherTeams = appConfig.teams.filter(t => !t.isMyTeam);
        let payerHtml = otherTeams.map(t => `<label class="radio-item"><input type="radio" name="payer_${tempId}" value="${t.name}" ${data?.payer === t.name ? 'checked' : ''} onchange="updateHeader(this)">${t.name}</label>`).join('');
        payerHtml += appConfig.members.map(m => `<label class="radio-item"><input type="radio" name="payer_${tempId}" value="${m}" ${data?.payer === m ? 'checked' : ''} onchange="updateHeader(this)">${m}</label>`).join('');
        const teamsHtml = appConfig.teams.map(t => `<label class="check-item"><input type="checkbox" class="team-check" value="${t.id}" data-name="${t.name}" ${data?.teams?.[t.id] !== false ? 'checked' : ''} onchange="updateHeader(this)">${t.name}</label>`).join('');

        div.innerHTML = `
            <button class="remove-btn" onclick="removeItem(this)">Ã—</button>
            <div class="item-header" onclick="toggleItem(this)">
                <span class="title-text" style="font-weight:bold;">ì°¨ìˆ˜ ì •ë³´ ì…ë ¥</span>
                <div class="sub-text"></div>
            </div>
            <div class="item-body">
                <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: ì ì‹¬)" class="item-name" value="${data?.name || ''}" oninput="updateHeader(this)">
                <input type="text" placeholder="ê²°ì œ ê¸ˆì•¡" class="item-amount" inputmode="numeric" value="${data?.amount || ''}" oninput="formatAmount(this); updateHeader(this)">
                <span class="label-text">ğŸ’³ ê²°ì œì</span>
                <div class="flex-group">${payerHtml}</div>
                <span class="label-text">ğŸ‘¥ ì°¸ì—¬íŒ€</span>
                <div class="flex-group">${teamsHtml}</div>
                <button class="save-btn" onclick="saveAndCollapse(this)">âœ” ì €ì¥ ë° ì ‘ê¸°</button>
            </div>`;
        list.appendChild(div);
        updateHeader(div.querySelector('.item-name'));
        return div;
    }

    // [V33.4] ë¹ˆ í•­ëª© ì²´í¬ + ìë™ ìŠ¤í¬ë¡¤
    function addNewItem() {
        const items = document.querySelectorAll('.item-group');
        if (items.length > 0) {
            const last = items[items.length - 1];
            const amt = last.querySelector('.item-amount').value;
            const pyr = last.querySelector(`input[type="radio"]:checked`);
            if (!amt || amt === "0" || !pyr) {
                alert("ì´ì „ ì°¨ìˆ˜ì˜ ê¸ˆì•¡ê³¼ ê²°ì œìë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                last.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
        }
        const newItem = renderItem();
        setTimeout(() => {
            newItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }

    function updateHeader(el) {
        const g = el.closest('.item-group');
        const name = g.querySelector('.item-name').value || "ì •ì‚° í•­ëª©";
        const amt = g.querySelector('.item-amount').value || "0";
        const payer = g.querySelector(`input[type="radio"]:checked`)?.parentElement.textContent || "ë¯¸ì„ íƒ";
        const teams = Array.from(g.querySelectorAll('.team-check:checked')).map(cb => cb.getAttribute('data-name')).join(', ');
        g.querySelector('.title-text').innerText = `${name} (${amt}ì›)`;
        g.querySelector('.sub-text').innerHTML = `ğŸ’³ ${payer} | ğŸ‘¥ ${teams || 'ì—†ìŒ'}`;
        saveToLocal();
    }

    function formatAmount(o) { let v = o.value.replace(/[^0-9]/g, ""); o.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function saveAndCollapse(b) { b.closest('.item-group').classList.add('collapsed'); saveToLocal(); }
    function toggleItem(h) { h.closest('.item-group').classList.toggle('collapsed'); }
    function removeItem(b) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { b.closest('.item-group').remove(); saveToLocal(); if(document.querySelectorAll('.item-group').length===0) loadData(); } }
    function clearAllItems() { if(confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) { localStorage.removeItem('settlementData'); location.reload(); } }

    function saveToLocal() {
        const items = [];
        document.querySelectorAll('.item-group').forEach(g => {
            const tid = g.getAttribute('data-id');
            const tcs = {};
            g.querySelectorAll('.team-check').forEach(cb => { tcs[cb.value] = cb.checked; });
            items.push({
                tempId: tid,
                name: g.querySelector('.item-name').value,
                amount: g.querySelector('.item-amount').value,
                payer: g.querySelector(`input[name="payer_${tid}"]:checked`)?.parentElement.textContent || "",
                teams: tcs,
                collapsed: g.classList.contains('collapsed')
            });
        });
        localStorage.setItem('settlementData', JSON.stringify(items));
    }

    // [ë³µêµ¬ëœ ì •ì‚° ë¡œì§]
    function calculate() {
        saveToLocal();
        const items = JSON.parse(localStorage.getItem('settlementData') || "[]");
        if(items.length === 0) return alert("ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        
        let total = 0;
        let teamPaid = {}; let teamSpent = {}; let memberPaid = {};
        appConfig.teams.forEach(t => { teamPaid[t.id] = 0; teamSpent[t.id] = 0; });
        appConfig.members.forEach(m => { memberPaid[m] = 0; });

        let tableHtml = `<table class="report-table"><tr><th>í•­ëª©</th><th>ê²°ì œ</th><th>ì°¸ì—¬íŒ€</th><th style="text-align:right;">ê¸ˆì•¡</th></tr>`;
        const myTeam = appConfig.teams.find(t => t.isMyTeam);

        items.forEach((item, idx) => {
            const amt = Number(item.amount.replace(/,/g,''));
            total += amt;
            const activeTeamNames = appConfig.teams.filter(t => item.teams[t.id]).map(t => t.name.split('(')[0]).join(', ');
            
            tableHtml += `<tr><td>${item.name || (idx+1)+'ì°¨'}</td><td>${item.payer}</td><td style="font-size:0.6rem; color:#aaa;">${activeTeamNames}</td><td style="text-align:right;">${amt.toLocaleString()}ì›</td></tr>`;

            if (appConfig.members.includes(item.payer)) {
                teamPaid[myTeam.id] += amt; memberPaid[item.payer] += amt;
            } else {
                const pt = appConfig.teams.find(t => t.name === item.payer);
                if (pt) teamPaid[pt.id] += amt;
            }

            const activeTeams = Object.keys(item.teams).filter(tid => item.teams[tid]);
            if (activeTeams.length > 0) {
                const per = amt / activeTeams.length;
                activeTeams.forEach(tid => { teamSpent[tid] += per; });
            }
        });
        tableHtml += `</table>`;

        // ì†¡ê¸ˆ ê°€ì´ë“œ ê³„ì‚°
        const truncate = (val) => Math.floor(Math.round(val) / appConfig.truncationUnit) * appConfig.truncationUnit;
        let diffs = appConfig.teams.map(t => ({ id: t.id, name: t.name, balance: teamPaid[t.id] - teamSpent[t.id] }));
        let guideMsg = "";
        
        let debtors = diffs.filter(d => d.balance < -1).sort((a,b) => a.balance - b.balance);
        let creditors = diffs.filter(d => d.balance > 1).sort((a,b) => b.balance - a.balance);

        debtors.forEach(debtor => {
            let debt = Math.abs(debtor.balance);
            creditors.forEach(creditor => {
                if (debt <= 0 || creditor.balance <= 0) return;
                let trade = Math.min(debt, creditor.balance);
                guideMsg += `<div class="guide-container" style="margin-bottom:10px;"><span style="color:#f39c12; font-weight:bold;">ğŸ’° ${debtor.name} â†’ ${creditor.name}</span><br><span style="font-size:0.9rem;">${truncate(trade).toLocaleString()}ì›</span></div>`;
                debt -= trade; creditor.balance -= trade;
            });
        });

        document.getElementById('reportHeader').innerHTML = tableHtml + `<div style="text-align:right; color:#f39c12; font-weight:bold; margin-top:5px;">ì´ì•¡: ${total.toLocaleString()}ì›</div>`;
        document.getElementById('reportGuide').innerHTML = `<hr style="border-color:#444;"><div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">ğŸ“ íŒ€ë³„ ì†¡ê¸ˆ ê°€ì´ë“œ</div>${guideMsg || 'ì •ì‚° ê¸ˆì•¡ ì—†ìŒ'}`;
        
        // ë‚´ë¶€ ì •ì‚° ì„¹ì…˜
        const perMember = teamSpent[myTeam.id] / appConfig.members.length;
        let statusHtml = "";
        let mBalances = {};
        appConfig.members.forEach(m => {
            const bal = memberPaid[m] - perMember;
            mBalances[m] = bal;
            statusHtml += `<div class="status-row"><span>${m}</span><span>${truncate(bal).toLocaleString()}ì›</span></div>`;
        });
        
        document.getElementById('privateSection').innerHTML = `<hr style="border-color:#444;"><div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">ğŸ“ ìš°ë¦¬íŒ€ ë‚´ë¶€ ì •ì‚°</div><div class="status-table">${statusHtml}</div>`;
        
        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
        document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
    }

    // ì„¤ì •ì°½ ë° ì´ë¯¸ì§€ ì €ì¥
    function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; renderSettingsUI(); }
    function renderSettingsUI() {
        const tl = document.getElementById('teamSettingList'); tl.innerHTML = "";
        appConfig.teams.forEach((t, i) => {
            tl.innerHTML += `<div style="display:flex; gap:5px; margin-bottom:5px;"><input type="radio" name="mt" ${t.isMyTeam?'checked':''} onclick="appConfig.teams.forEach((x,j)=>x.isMyTeam=(i===j))"><input type="text" value="${t.name}" onchange="appConfig.teams[${i}].name=this.value" style="flex:1;"></div>`;
        });
        const ml = document.getElementById('memberSettingList'); ml.innerHTML = "";
        appConfig.members.forEach((m, i) => {
            ml.innerHTML += `<div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" value="${m}" onchange="appConfig.members[${i}]=this.value" style="flex:1;"></div>`;
        });
        const tr = document.getElementById('truncOptions');
        tr.innerHTML = [1, 10, 100].map(u => `<label class="radio-item"><input type="radio" name="tr" onclick="appConfig.truncationUnit=${u}" ${appConfig.truncationUnit===u?'checked':''}>${u}ì›</label>`).join('');
    }
    function saveSettings() { localStorage.setItem('appConfig', JSON.stringify(appConfig)); location.reload(); }
    function addTeamInput() { appConfig.teams.push({id:'t'+Date.now(), name:'ìƒˆ íŒ€', isMyTeam:false}); renderSettingsUI(); }
    function addMemberInput() { appConfig.members.push('ìƒˆ ë©¤ë²„'); renderSettingsUI(); }
    
    function saveAsImage() {
        const ps = document.getElementById('privateSection'); ps.style.display = 'none';
        html2canvas(document.getElementById('captureArea')).then(canvas => {
            const a = document.createElement('a'); a.download = 'ì •ì‚°ë¦¬í¬íŠ¸.png'; a.href = canvas.toDataURL(); a.click();
            ps.style.display = 'block';
        });
    }
</script>
</body>
</html>
