<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒ€ ì •ì‚° ì–´í”Œ (Final V35)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* [Update: 2026-02-17-v35] ì§ê´€ì  ì…ë ¥ UI ê°œì„ : ì „ì²´ ì„ íƒ ë²„íŠ¼, ì´ì „ íŒ€ ë³µì‚¬, ë°°ì§€ ìŠ¤íƒ€ì¼ */
        :root { --primary: #4a90e2; --bg: #f2f4f7; --card-bg: #ffffff; --danger: #ff4d4f; --success: #28a745; --dark: #2d3436; --gray-border: #dfe6e9; --accent: #6c5ce7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 450px; margin: 0 auto; padding-bottom: 30px; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px 5px; }
        .app-title { font-size: 1.25rem; color: #333; font-weight: 800; margin: 0; display: flex; align-items: center; gap: 6px; }
        .setting-btn { background: #fff; border: 1px solid #ddd; padding: 7px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; color: #555; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .card { background: var(--card-bg); padding: 15px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 12px; }
        
        /* í•­ëª© ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #itemList { max-height: 60vh; overflow-y: auto; padding-right: 4px; margin-bottom: 15px; scroll-behavior: smooth; }
        .item-group { border: 1px solid #eee; border-radius: 14px; margin-bottom: 12px; overflow: hidden; background: #fff; position: relative; transition: all 0.2s; }
        .item-group.collapsed { border-left: 6px solid var(--success); background: #fafbfc; }
        
        .item-header { padding: 12px 45px 12px 15px; cursor: pointer; }
        .item-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .title-text { font-weight: 800; font-size: 1rem; color: #2d3436; }
        .badge-list { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 5px; }
        .badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: #eee; color: #777; }
        .badge.active { background: rgba(74, 144, 226, 0.1); color: var(--primary); border: 1px solid rgba(74, 144, 226, 0.2); }
        .badge.payer { background: rgba(108, 92, 231, 0.1); color: var(--accent); border: 1px solid rgba(108, 92, 231, 0.2); }

        .remove-btn { position: absolute; right: 8px; top: 10px; background: #eee; color: #999; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: none; z-index: 5; }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .item-body { padding: 15px; border-top: 1px solid #f5f5f5; background: #fdfdfd; }
        .collapsed .item-body { display: none; }
        
        .input-label { font-size: 0.8rem; font-weight: 700; color: #555; margin: 12px 0 6px 0; display: block; }
        input[type="text"], input[type="tel"] { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        
        .quick-actions { display: flex; gap: 5px; margin-bottom: 8px; }
        .quick-btn { flex: 1; padding: 6px; font-size: 0.7rem; background: #f1f3f5; border: 1px solid #dee2e6; border-radius: 6px; color: #666; cursor: pointer; }

        .chip-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 6px; }
        .chip { position: relative; cursor: pointer; }
        .chip input { position: absolute; opacity: 0; cursor: pointer; }
        .chip-label { display: block; padding: 10px 4px; text-align: center; border: 1px solid #ddd; border-radius: 10px; font-size: 0.8rem; color: #888; background: #fff; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chip input:checked + .chip-label { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(74, 144, 226, 0.2); }
        .chip.payer-chip input:checked + .chip-label { background: var(--accent); border-color: var(--accent); }

        /* ê²°ê³¼ ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
        .result-box { background: var(--dark); color: #fff; padding: 20px; border-radius: 18px; display: none; margin-top: 15px; }
        .report-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.75rem; color: #ddd; }
        .report-table th { border-bottom: 1px solid #555; padding: 8px 4px; text-align: left; color: #aaa; }
        .report-table td { padding: 8px 4px; border-bottom: 1px solid #444; }
        .highlight { color: #f39c12; font-weight: bold; }

        /* ë²„íŠ¼ë“¤ */
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }
        .add-btn { background: #495057; color: white; margin-bottom: 8px; }
        .calc-btn { background: var(--primary); color: white; margin-top: 5px; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3); font-size: 1.1rem; }
        .clear-btn { background: transparent; color: #adb5bd; font-size: 0.8rem; margin-top: 10px; text-decoration: underline; }
        .save-btn { background: var(--success); color: white; margin-top: 15px; }
        .image-btn { background: var(--accent); color: white; margin-top: 15px; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ìƒëµ (ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #fff; width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; max-height: 85vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1 class="app-title">ğŸ§¾ íŒ€ ì •ì‚° ì–´í”Œ <small style="font-size:0.6rem; color:#999; margin-left:5px;">V35</small></h1>
        <button class="setting-btn" onclick="openSettings()">âš™ï¸ ì„¤ì •</button>
    </div>

    <div class="card">
        <div id="itemList"></div>
        <button class="add-btn" onclick="addNewItem()">+ ìƒˆë¡œìš´ ì°¨ìˆ˜ ì¶”ê°€</button>
        <button class="calc-btn" onclick="calculate()">ğŸš€ ì •ì‚° ê²°ê³¼ í™•ì¸</button>
        <button class="clear-btn" onclick="clearAllItems()">ëª¨ë“  ë‚´ì—­ ì§€ìš°ê¸°</button>
    </div>

    <div id="captureArea">
        <div id="result" class="result-box card">
            <h3 style="color:white; margin-top:0; text-align:center;">ğŸ“Š ìµœì¢… ì •ì‚° ë¦¬í¬íŠ¸</h3>
            <div id="reportHeader"></div>
            <div id="reportGuide"></div>
            <div id="privateSection"></div>
        </div>
    </div>
    
    <div id="actionButtons" style="display:none; padding: 0 10px;">
        <button class="image-btn" onclick="saveAsImage()">ğŸ–¼ï¸ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="margin-top:0; text-align:center;">âš™ï¸ ì„¤ì • ê´€ë¦¬</h3>
        <div style="margin-bottom:20px;">
            <label style="font-size:0.85rem; font-weight:bold; color:var(--primary);">ğŸ‘¥ ì „ì²´ íŒ€ ëª©ë¡</label>
            <div id="teamSettingList" style="margin-top:10px;"></div>
            <button onclick="addTeamInput()" style="background:#eee; color:#333; padding:8px; font-size:0.8rem; margin-top:5px;">+ íŒ€ ì¶”ê°€</button>
        </div>
        <div style="margin-bottom:20px;">
            <label style="font-size:0.85rem; font-weight:bold; color:var(--success);">ğŸ‘¤ ìš°ë¦¬ íŒ€ì› ëª©ë¡</label>
            <div id="memberSettingList" style="margin-top:10px;"></div>
            <button onclick="addMemberInput()" style="background:#eee; color:#333; padding:8px; font-size:0.8rem; margin-top:5px;">+ íŒ€ì› ì¶”ê°€</button>
        </div>
        <div>
            <label style="font-size:0.85rem; font-weight:bold;">ğŸ’° ì ˆì‚¬ ë‹¨ìœ„</label>
            <div id="truncOptions" style="display:flex; gap:10px; margin-top:10px;"></div>
        </div>
        <button onclick="saveSettings()" style="background:var(--dark); color:white; margin-top:20px;">ì €ì¥í•˜ê³  ë‹«ê¸°</button>
        <button onclick="factoryReset()" style="background:#fff0f0; color:#ff4d4f; border:1px solid #ffccc7; font-size:0.8rem; margin-top:10px;">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>
</div>

<script>
    const defaultConfig = {
        teams: [
            { id: 'teamA', name: "AíŒ€", isMyTeam: false },
            { id: 'teamB', name: "BíŒ€", isMyTeam: false },
            { id: 'teamC', name: "CíŒ€", isMyTeam: true }
        ],
        members: ["ì§€í›ˆ", "ì€í˜œ"],
        truncationUnit: 1
    };

    let appConfig = JSON.parse(localStorage.getItem('appConfig')) || defaultConfig;

    window.onload = function() { loadData(); }

    function openSettings() { renderSettingsUI(); document.getElementById('settingsModal').style.display = 'flex'; }
    function renderSettingsUI() {
        const teamList = document.getElementById('teamSettingList');
        teamList.innerHTML = '';
        appConfig.teams.forEach((t, i) => {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
            div.innerHTML = `<input type="radio" name="myTeamIdx" ${t.isMyTeam?'checked':''} onclick="updateMyTeam(${i})">
                             <input type="text" value="${t.name}" onchange="appConfig.teams[${i}].name=this.value" style="flex:1; padding:6px; font-size:0.85rem;">
                             <button onclick="removeTeam(${i})" style="width:30px; background:#ff4d4f; color:white; padding:0; border-radius:4px;">Ã—</button>`;
            teamList.appendChild(div);
        });

        const memberList = document.getElementById('memberSettingList');
        memberList.innerHTML = '';
        appConfig.members.forEach((m, i) => {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
            div.innerHTML = `<input type="text" value="${m}" onchange="appConfig.members[${i}]=this.value" style="flex:1; padding:6px; font-size:0.85rem;">
                             <button onclick="removeMember(${i})" style="width:30px; background:#ff4d4f; color:white; padding:0; border-radius:4px;">Ã—</button>`;
            memberList.appendChild(div);
        });

        const truncList = document.getElementById('truncOptions');
        [1, 10, 100].forEach(u => {
            const label = document.createElement('label');
            label.style.fontSize = '0.8rem';
            label.innerHTML = `<input type="radio" name="tr" ${appConfig.truncationUnit==u?'checked':''} onclick="appConfig.truncationUnit=${u}"> ${u}ì›`;
            truncList.appendChild(label);
        });
    }

    function addTeamInput() { appConfig.teams.push({id:'t'+Date.now(), name:'ìƒˆíŒ€', isMyTeam:false}); renderSettingsUI(); }
    function removeTeam(i) { appConfig.teams.splice(i,1); renderSettingsUI(); }
    function updateMyTeam(i) { appConfig.teams.forEach((t,idx)=> t.isMyTeam = (idx===i)); }
    function addMemberInput() { appConfig.members.push('ìƒˆíŒ€ì›'); renderSettingsUI(); }
    function removeMember(i) { appConfig.members.splice(i,1); renderSettingsUI(); }
    function saveSettings() { localStorage.setItem('appConfig', JSON.stringify(appConfig)); location.reload(); }
    function factoryReset() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); location.reload(); } }

    function loadData() {
        const saved = localStorage.getItem('settlementData');
        const list = document.getElementById('itemList');
        list.innerHTML = "";
        if (saved && JSON.parse(saved).length > 0) { JSON.parse(saved).forEach(item => renderItem(item)); }
        else { addNewItem(); }
    }

    function renderItem(data = null) {
        const list = document.getElementById('itemList');
        const tempId = Date.now() + Math.random();
        const div = document.createElement('div');
        div.className = `item-group ${data?.collapsed ? 'collapsed' : ''}`;
        div.setAttribute('data-id', tempId);

        // ì´ì „ ì°¨ìˆ˜ì˜ íŒ€ ì°¸ì—¬ ì •ë³´ë¥¼ ë³µì‚¬í•´ì˜¤ê¸° (ë°ì´í„°ê°€ ì—†ëŠ” ì‹ ê·œ ìƒì„±ì¼ ë•Œë§Œ)
        let defaultTeams = {};
        if (!data) {
            const allGroups = document.querySelectorAll('.item-group');
            if (allGroups.length > 0) {
                const lastGroup = allGroups[allGroups.length - 1];
                lastGroup.querySelectorAll('.team-check').forEach(cb => { defaultTeams[cb.value] = cb.checked; });
            }
        }

        const payerChips = [
            ...appConfig.teams.filter(t=>!t.isMyTeam).map(t => t.name),
            ...appConfig.members
        ].map(name => `
            <label class="chip payer-chip">
                <input type="radio" name="payer_${tempId}" value="${name}" ${data?.payer === name ? 'checked' : ''} onchange="updateHeader(this)">
                <span class="chip-label">${name}</span>
            </label>
        `).join('');

        const teamChips = appConfig.teams.map(t => `
            <label class="chip">
                <input type="checkbox" class="team-check" value="${t.id}" data-name="${t.name}" 
                    ${data ? (data.teams?.[t.id] !== false ? 'checked' : '') : (defaultTeams[t.id] !== false ? 'checked' : '')} 
                    onchange="updateHeader(this)">
                <span class="chip-label">${t.name}</span>
            </label>
        `).join('');

        div.innerHTML = `
            <button class="remove-btn" onclick="removeItem(this)">Ã—</button>
            <div class="item-header" onclick="toggleItem(this)">
                <div class="item-header-top">
                    <span class="title-text">ìƒˆë¡œìš´ ì°¨ìˆ˜</span>
                    <span class="header-amount" style="font-weight:bold; color:var(--primary);"></span>
                </div>
                <div class="badge-list"></div>
            </div>
            <div class="item-body">
                <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: 1ì°¨ ê°ìíƒ•)" class="item-name" value="${data?.name || ''}" oninput="updateHeader(this)">
                <input type="tel" placeholder="ê²°ì œ ê¸ˆì•¡ ì…ë ¥" class="item-amount" value="${data?.amount || ''}" oninput="formatAmount(this); updateHeader(this)">
                
                <span class="input-label">ğŸ’³ ëˆ„ê°€ ê²°ì œí–ˆë‚˜ìš”?</span>
                <div class="chip-group">${payerChips}</div>

                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <span class="input-label">ğŸ‘¥ ì°¸ì—¬ íŒ€ ì„ íƒ</span>
                    <div class="quick-actions" style="margin-bottom:5px;">
                        <span class="quick-btn" onclick="toggleAllTeams(this, true)">ì „ì²´ ì„ íƒ</span>
                        <span class="quick-btn" onclick="toggleAllTeams(this, false)">ì „ì²´ í•´ì œ</span>
                    </div>
                </div>
                <div class="chip-group">${teamChips}</div>

                <button class="save-btn" onclick="saveAndCollapse(this)">ì´ ë‚´ì—­ ì €ì¥í•˜ê³  ì ‘ê¸°</button>
            </div>
        `;
        list.appendChild(div);
        updateHeader(div.querySelector('.item-name'));
    }

    function toggleAllTeams(btn, state) {
        const body = btn.closest('.item-body');
        body.querySelectorAll('.team-check').forEach(cb => cb.checked = state);
        updateHeader(body);
        event.stopPropagation();
    }

    function updateHeader(el) {
        const g = el.closest('.item-group');
        const name = g.querySelector('.item-name').value;
        const amt = g.querySelector('.item-amount').value || "0";
        const payer = g.querySelector(`input[type="radio"]:checked`)?.value;
        const teams = Array.from(g.querySelectorAll('.team-check:checked')).map(cb => cb.getAttribute('data-name'));
        
        const idx = Array.from(document.querySelectorAll('.item-group')).indexOf(g) + 1;
        g.querySelector('.title-text').innerText = name || idx + "ì°¨ í•­ëª©";
        g.querySelector('.header-amount').innerText = amt !== "0" ? amt + "ì›" : "";
        
        let badges = "";
        if(payer) badges += `<span class="badge payer">ğŸ’³ ${payer} ê²°ì œ</span>`;
        if(teams.length > 0) badges += `<span class="badge active">ğŸ‘¥ ${teams.length}íŒ€ ì°¸ì—¬</span>`;
        g.querySelector('.badge-list').innerHTML = badges;
        saveToLocal();
    }

    function formatAmount(obj) { let v = obj.value.replace(/[^0-9]/g, ""); obj.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function addNewItem() { renderItem(); window.scrollTo(0, document.body.scrollHeight); }
    function toggleItem(h) { h.closest('.item-group').classList.toggle('collapsed'); }
    function saveAndCollapse(b) { b.closest('.item-group').classList.add('collapsed'); }
    function removeItem(b) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { b.closest('.item-group').remove(); saveToLocal(); } }
    
    function saveToLocal() {
        const items = [];
        document.querySelectorAll('.item-group').forEach(g => {
            const tid = g.getAttribute('data-id');
            const teamChecks = {};
            g.querySelectorAll('.team-check').forEach(cb => { teamChecks[cb.value] = cb.checked; });
            items.push({
                name: g.querySelector('.item-name').value,
                amount: g.querySelector('.item-amount').value,
                payer: g.querySelector(`input[name="payer_${tid}"]:checked`)?.value || "",
                teams: teamChecks,
                collapsed: g.classList.contains('collapsed')
            });
        });
        localStorage.setItem('settlementData', JSON.stringify(items));
    }

    function clearAllItems() { if(confirm("ì •ë§ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?")) { localStorage.removeItem('settlementData'); loadData(); } }

    function applyTruncate(amount) {
        const unit = appConfig.truncationUnit || 1;
        return Math.floor(Math.round(amount) / unit) * unit;
    }

    function calculate() {
        saveToLocal();
        const items = JSON.parse(localStorage.getItem('settlementData') || "[]");
        if(!items.some(i=>i.amount)) return alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        let total = 0;
        let teamPaid = {}; let teamSpent = {}; let memberPaid = {};
        appConfig.teams.forEach(t => { teamPaid[t.id] = 0; teamSpent[t.id] = 0; });
        appConfig.members.forEach(m => { memberPaid[m] = 0; });

        let tableHtml = `<table class="report-table"><tr><th>í•­ëª©</th><th>ê²°ì œì</th><th>ì°¸ì—¬</th><th style="text-align:right;">ê¸ˆì•¡</th></tr>`;
        const myTeam = appConfig.teams.find(t => t.isMyTeam);

        items.forEach((item, idx) => {
            if(!item.amount || !item.payer) return;
            const amt = Number(item.amount.replace(/,/g,''));
            total += amt;

            const activeTids = Object.keys(item.teams).filter(tid => item.teams[tid]);
            const teamNames = activeTids.map(tid => appConfig.teams.find(t=>t.id===tid)?.name.split('(')[0]).join(',');

            tableHtml += `<tr><td>${item.name || (idx+1)+'ì°¨'}</td><td>${item.payer}</td><td style="color:#888; font-size:0.6rem;">${teamNames}</td><td style="text-align:right;">${amt.toLocaleString()}</td></tr>`;

            if (appConfig.members.includes(item.payer)) {
                teamPaid[myTeam.id] += amt; memberPaid[item.payer] += amt;
            } else {
                const pt = appConfig.teams.find(t => t.name === item.payer);
                if (pt) teamPaid[pt.id] += amt;
            }

            if (activeTids.length > 0) {
                const perTeam = amt / activeTids.length;
                activeTids.forEach(tid => teamSpent[tid] += perTeam);
            }
        });

        // ì†¡ê¸ˆ ë¡œì§ (íŒ€ ê°„)
        let diffs = appConfig.teams.map(t => ({ id: t.id, name: t.name, balance: teamPaid[t.id] - teamSpent[t.id] }));
        let guideMsg = "";
        diffs.filter(d => d.balance < -1).forEach(debtor => {
            let debt = Math.abs(debtor.balance);
            diffs.filter(c => c.balance > 1).forEach(creditor => {
                if (debt <= 0 || creditor.balance <= 0) return;
                let share = Math.min(debt, creditor.balance);
                guideMsg += `<div style="margin-bottom:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;">
                                <div style="color:#f39c12; font-weight:bold; font-size:0.85rem;">${debtor.name} â†’ ${creditor.name}</div>
                                <div style="font-size:1.1rem; font-weight:800; margin-top:4px;">${applyTruncate(share).toLocaleString()}ì›</div>
                             </div>`;
                debt -= share; creditor.balance -= share;
            });
        });

        document.getElementById('reportHeader').innerHTML = tableHtml + `</table><div style="text-align:right; font-weight:bold; margin:15px 0; color:#f39c12; font-size:1.1rem;">ì´ì•¡: ${total.toLocaleString()}ì›</div>`;
        document.getElementById('reportGuide').innerHTML = `<div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">ğŸ“ ìµœì¢… ì†¡ê¸ˆ ê°€ì´ë“œ</div>${guideMsg || "ì •ì‚°í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}`;
        
        // ë‚´ë¶€ ì •ì‚° ë¡œì§
        const myTeamSpent = teamSpent[myTeam.id];
        const perMem = myTeamSpent / appConfig.members.length;
        let statusHtml = `<div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; font-size:0.75rem;">`;
        let mBalances = {};
        appConfig.members.forEach(m => {
            const bal = memberPaid[m] - perMem;
            mBalances[m] = bal;
            const resColor = bal >= 0 ? '#2ecc71' : '#ff6b6b';
            statusHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>${m}</span>
                            <span>ë‚¸ëˆ:${Math.round(memberPaid[m]).toLocaleString()} / ëª«:${applyTruncate(perMem).toLocaleString()}</span>
                            <span style="color:${resColor}; font-weight:bold;">${bal > 0 ? '+':''}${applyTruncate(bal).toLocaleString()}</span>
                           </div>`;
        });
        statusHtml += `</div>`;

        let internalStep = "";
        let givers = Object.keys(mBalances).filter(m => mBalances[m] < -1);
        let receivers = Object.keys(mBalances).filter(m => mBalances[m] > 1);
        givers.forEach(g => {
            receivers.forEach(r => {
                let d = Math.abs(mBalances[g]); let c = mBalances[r];
                if (d < 1 || c < 1) return;
                let trade = Math.min(d, c);
                mBalances[g] += trade; mBalances[r] -= trade;
                internalStep += `<div style="font-size:0.85rem; margin-top:5px; border-left:3px solid var(--danger); padding-left:8px;">${g} â†’ ${r}: <b>${applyTruncate(trade).toLocaleString()}ì›</b></div>`;
            });
        });

        let externalStep = "";
        Object.keys(mBalances).forEach(m => {
            if (Math.abs(mBalances[m]) > 10) {
                const amt = applyTruncate(Math.abs(mBalances[m]));
                externalStep += `<div style="font-size:0.85rem; margin-top:5px; border-left:3px solid var(--success); padding-left:8px;">${m}: ì™¸ë¶€ì™€ <b>${amt.toLocaleString()}ì›</b> ${mBalances[m]>0?'ë°›ê¸°':'ë³´ë‚´ê¸°'}</div>`;
            }
        });

        document.getElementById('privateSection').innerHTML = `
            <hr style="border:0; border-top:1px dashed #555; margin:20px 0;">
            <div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">ğŸ“ ${myTeam.name} ë‚´ë¶€ ì •ì‚° ì„¸ë¶€</div>
            ${statusHtml}
            <div style="margin-top:10px;">${internalStep}</div>
            <div style="margin-top:5px;">${externalStep}</div>
        `;

        document.getElementById('result').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function saveAsImage() {
        const priv = document.getElementById('privateSection');
        priv.style.display = 'none'; // ì´ë¯¸ì§€ ì €ì¥ ì‹œ ë‚´ë¶€ ì •ì‚°ì€ ê°€ë¦¬ê³  ì‹¶ì„ ë•Œ
        html2canvas(document.getElementById('captureArea'), { backgroundColor: "#f2f4f7", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ì •ì‚°ë¦¬í¬íŠ¸_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
            priv.style.display = 'block';
        });
    }
</script>
</body>
</html>